<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì²­ë¼í•˜ëŠ˜ëŒ€êµ ê±·ê¸° ì±Œë¦°ì§€</title>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.card {
    background: white;
    width: 420px;
    max-width: 95%;
    padding: 25px;
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    text-align: center;
}
.status {
    margin: 10px 0;
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    background: #eee;
}
button {
    margin: 6px;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.start { background: #4CAF50; color: white; }
.stop { background: #f44336; color: white; }
.shop { background: #ff9800; color: white; }
.reset-btn {
    margin-top: 10px;
    background: #555;
    color: white;
}
.stamp-container {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
}
.stamp {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ff9800;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}
</style>
</head>
<body>

<div class="card">
    <h2>ì²­ë¼í•˜ëŠ˜ëŒ€êµ ê±·ê¸° ì±Œë¦°ì§€</h2>

    <div class="status" id="status">ëŒ€ê¸° ì¤‘</div>

    <p>í˜„ì¬ ê±°ë¦¬: <b id="distance">0</b> km</p>
    <p>ëˆ„ì  í¬ì¸íŠ¸: <b id="points">0</b> P</p>
    <p>ì™„ì£¼ ë„ì¥: <b id="stampCount">0</b></p>

    <button class="start" onclick="startTracking()">ê±·ê¸° ì‹œì‘</button>
    <button class="stop" onclick="stopTracking()">ì¤‘ì§€</button>
    <button class="shop" onclick="location.href='shop.html'">í¬ì¸íŠ¸ ì‚¬ìš©</button>
    <button id="resetBtn" class="reset-btn">ê¸°ë¡ ì´ˆê¸°í™”</button>

    <div id="coords" style="font-size:12px;color:gray;"></div>
    <div class="stamp-container" id="stamps"></div>
</div>

<script>
const POINT_PER_KM = 100;
const COMPLETE_BONUS = 50;
const DAILY_LIMIT = 1000;

const bridgeStart = { lat: 37.54180, lng: 126.61420 };
const bridgeEnd   = { lat: 37.49350, lng: 126.50880 };
const radius = 0.3;

let watchId = null;
let measuring = false;
let prevPosition = null;
let totalDistance = 0;

let totalPoints = Number(localStorage.getItem("points")) || 0;
let stampCount = Number(localStorage.getItem("stamps")) || 0;
let savedDistance = Number(localStorage.getItem("currentDistance")) || 0;

totalDistance = savedDistance;

document.getElementById("points").innerText = totalPoints;
document.getElementById("stampCount").innerText = stampCount;
document.getElementById("distance").innerText = totalDistance.toFixed(3);
renderStamps();

function updateStatus(text, color="#eee") {
    const el = document.getElementById("status");
    el.innerText = text;
    el.style.background = color;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function isNear(point, current) {
    return calculateDistance(point.lat, point.lng, current.lat, current.lng) < radius;
}

function addPoints(earnedPoints) {
    let todayEarned = Number(localStorage.getItem("todayEarned")) || 0;
    if (todayEarned + earnedPoints > DAILY_LIMIT) {
        earnedPoints = Math.max(0, DAILY_LIMIT - todayEarned);
    }
    todayEarned += earnedPoints;
    localStorage.setItem("todayEarned", todayEarned);

    totalPoints += earnedPoints;
    localStorage.setItem("points", totalPoints);
    document.getElementById("points").innerText = totalPoints;

    return earnedPoints;
}

function startTracking() {
    if (!navigator.geolocation) {
        updateStatus("GPS ë¯¸ì§€ì›", "#ffcccc");
        return;
    }

    updateStatus("ë‹¤ë¦¬ ì‹œì‘ì  ëŒ€ê¸° ì¤‘...", "#fff3cd");

    watchId = navigator.geolocation.watchPosition(position => {

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        document.getElementById("coords").innerText =
            "ìœ„ë„: " + lat.toFixed(6) +
            " / ê²½ë„: " + lng.toFixed(6) +
            " / ì •í™•ë„: " + Math.round(accuracy) + "m";

        const current = { lat, lng };

        if (!measuring && (isNear(bridgeStart, current) || isNear(bridgeEnd, current))) {
            measuring = true;
            prevPosition = current;
            updateStatus("ğŸ“ ì¸¡ì • ì‹œì‘!", "#d4edda");
            return;
        }

        if (measuring && prevPosition) {

            if (accuracy > 30) return;

            const dist = calculateDistance(
                prevPosition.lat,
                prevPosition.lng,
                lat,
                lng
            );

            if (dist < 0.003) return;
            if (dist > 0.03) return;

            totalDistance += dist;
            prevPosition = current;

            document.getElementById("distance").innerText =
                totalDistance.toFixed(3);

            localStorage.setItem("currentDistance", totalDistance);

            if (isNear(bridgeEnd, current)) {
                completeChallenge();
            }
        }

    }, error => {
        updateStatus("ìœ„ì¹˜ ì˜¤ë¥˜: " + error.message, "#ffcccc");
    }, {
        enableHighAccuracy: true
    });
}

function completeChallenge() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
    }

    measuring = false;

    let earnedPoints = Math.floor(totalDistance * POINT_PER_KM);
    earnedPoints += COMPLETE_BONUS;

    earnedPoints = addPoints(earnedPoints);

    stampCount++;
    localStorage.setItem("stamps", stampCount);
    localStorage.removeItem("currentDistance");

    document.getElementById("stampCount").innerText = stampCount;
    renderStamps();

    updateStatus("ğŸ‰ ì™„ì£¼ ì„±ê³µ! +" + earnedPoints + "P", "#c3e6cb");

    totalDistance = 0;
    document.getElementById("distance").innerText = "0";
}

function stopTracking() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
    }

    if (measuring) {
        let earnedPoints = Math.floor(totalDistance * POINT_PER_KM);
        earnedPoints = addPoints(earnedPoints);
        updateStatus("ì¤‘ì§€ â€” +" + earnedPoints + "P", "#f8d7da");
    } else {
        updateStatus("ì¸¡ì • ì‹œì‘ ì „ ì¢…ë£Œ", "#eee");
    }

    measuring = false;
    totalDistance = 0;
    prevPosition = null;
    localStorage.removeItem("currentDistance");
    document.getElementById("distance").innerText = "0";
}

function renderStamps() {
    const container = document.getElementById("stamps");
    container.innerHTML = "";
    for (let i = 0; i < stampCount; i++) {
        const stamp = document.createElement("div");
        stamp.className = "stamp";
        stamp.innerText = "âœ“";
        container.appendChild(stamp);
    }
}

document.getElementById("resetBtn").addEventListener("click", function () {
    if (confirm("ëª¨ë“  ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.clear();
        location.reload();
    }
});
</script>

</body>
</html>
